<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infrastructure &mdash; Clinicult 0.2 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Admin Management Services" href="admin_management_services.html" />
    <link rel="prev" title="Services" href="services.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/clinicult.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="scenarios.html">Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Infrastructure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="#aws">AWS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#terraform">Terraform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#s3">S3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ecs">ECS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ecr">ECR</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sns">SNS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#amplify">Amplify</a></li>
<li class="toctree-l3"><a class="reference internal" href="#schema">Schema</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#source-control">Source Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#continous-integration">Continous Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="admin_management_services.html">Admin Management Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfaces.html">Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Clinicult</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Infrastructure</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/infrastructure.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="infrastructure">
<h1>Infrastructure<a class="headerlink" href="#infrastructure" title="Permalink to this headline"></a></h1>
<p>Clinicult 2.0 Services will be deployed on AWS platform. The deployment will be on <a class="reference external" href="https://kubernetes.io/">Kubernetes</a>.
in addition to the services Clinicult 2.0 will have some storage for files and historic data.</p>
<p>All platform Code will be managed by Git on <a class="reference external" href="https://github.com">Github</a>.</p>
<p>Fully CI/CD will be part of the development cycle to ensure the platform Quality. the CI/CD engine will be <a class="reference external" href="https://github.com/features/actions">Github-Actions</a>.</p>
<section id="docker">
<h2>Docker<a class="headerlink" href="#docker" title="Permalink to this headline"></a></h2>
<p>To Deploy our services on the cloud, we will use <a class="reference external" href="https://www.docker.com/">Docker</a> containers.
Each service in our platform will be build on seperate Docker image and will deployed and different Pod/Service on the Cluster.</p>
<p>As part of the <a class="reference internal" href="#continous-integration"><span class="std std-ref">Continous Integration</span></a> the service will be build to and image and will be pushed to the Container registry for deployment.</p>
<p>The base image to build the service is depends on the service infrastructure. for example, if the service will be developed in python fastapi, the relevant base image is in <a class="reference external" href="https://hub.docker.com/r/tiangolo/uvicorn-gunicorn-fastapi">This Repository</a>.
The deployment of the image on the cluster will be part of the AWS infrastructure.</p>
<p>Each Image will have option to run as  debug or as production. the option will be set threw Environment variable.
in addition the image will have option to read alot of other values from Environment variable as well.</p>
<p>The Docker container will expose some port for listening to incoming requests.</p>
<p>Example of Dockerfile in fastapi infrastructure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">tiangolo</span><span class="o">/</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">fastapi</span><span class="p">:</span><span class="n">python3</span><span class="mf">.7</span>

<span class="c1"># Install Poetry</span>
<span class="n">RUN</span> <span class="n">curl</span> <span class="o">-</span><span class="n">sSL</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">poetry</span><span class="o">/</span><span class="n">poetry</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">get</span><span class="o">-</span><span class="n">poetry</span><span class="o">.</span><span class="n">py</span> <span class="o">|</span>
    <span class="n">POETRY_HOME</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">poetry</span> <span class="n">python</span> <span class="o">&amp;&amp;</span> \
    <span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span> <span class="o">&amp;&amp;</span> \
    <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">poetry</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">poetry</span> <span class="o">&amp;&amp;</span> \
    <span class="n">poetry</span> <span class="n">config</span> <span class="n">virtualenvs</span><span class="o">.</span><span class="n">create</span> <span class="n">false</span>

<span class="c1"># Copy using poetry.lock* in case it doesn&#39;t exist yet</span>
<span class="n">COPY</span> <span class="o">./</span><span class="n">app</span><span class="o">/</span><span class="n">pyproject</span><span class="o">.</span><span class="n">toml</span> <span class="o">./</span><span class="n">app</span><span class="o">/</span><span class="n">poetry</span><span class="o">.</span><span class="n">lock</span><span class="o">*</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span>

<span class="n">RUN</span> <span class="n">poetry</span> <span class="n">install</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">root</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">dev</span>

<span class="n">COPY</span> <span class="o">./</span><span class="n">app</span> <span class="o">/</span><span class="n">app</span>
</pre></div>
</div>
<p>For more information about the deployment you can find on <a class="reference internal" href="#ecs"><span class="std std-ref">ECS</span></a> chapter</p>
</section>
<section id="aws">
<h2>AWS<a class="headerlink" href="#aws" title="Permalink to this headline"></a></h2>
<section id="terraform">
<h3>Terraform<a class="headerlink" href="#terraform" title="Permalink to this headline"></a></h3>
<p>Aws services will be managed by <a class="reference external" href="https://www.terraform.io/">Terraform project</a>.</p>
<p>In our Account we will have 3 seperated environments:</p>
<ol class="arabic simple">
<li><p>development - will be used during the development stage</p></li>
<li><p>staging - for latest test before upgrading the production, or to test Beta versions</p></li>
<li><p>production - production Environment</p></li>
</ol>
<p>All the Environments will be <strong>identical</strong>!.</p>
<p>The deployment will be with terraform scripts. that each change will be only can modified from terraform. the changes will be applied manually only. CI for terraform scripts will just check validation of the scripts.
Terraform will save his environment state on S3.</p>
<p>In addition to the product environments, Terraform will also apllied usful lambda functions to help during the deployment stage. for example, Lambda function that update ECS clusters with new version uploaded.</p>
<p>Another imprtant example for lambda function is to deploy new cluster (aka new Clinic) on ECS.</p>
</section>
<section id="s3">
<h3>S3<a class="headerlink" href="#s3" title="Permalink to this headline"></a></h3>
<p>Each service in the cluster will have the option to get access to S3.
Clinicult 2.0 will have S3 storage per cluster (aka Clinic) the path in the S3 will idetify the relevant service.
For example, Service visits, will write his data to</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">s3://&lt;clinic_name&gt;/visits</span>
</pre></div>
</div>
</section>
<section id="ecs">
<h3>ECS<a class="headerlink" href="#ecs" title="Permalink to this headline"></a></h3>
<p>Each Clinic in Clinicult 2.0 will A seperate cluster in ECS fargate. each service will be an ECS service in the cluster.
for each Clinic will be a dedicated subnet in the environment VPC. this way, we will have 3 different VPCs, for development, staging and production. and each clinic will have seperate subnet in the VPC.</p>
<p>Amazon Api Gateway may be integrated with ECS. more information may be found in <a class="reference external" href="https://aws.amazon.com/blogs/compute/using-amazon-api-gateway-with-microservices-deployed-on-amazon-ecs/">this guide</a>.</p>
<p>All the clusters (aka clinics) will be accessed from the Api gateway <strong>only</strong>, and will be secured with TLS certivficate.
In addition, the clusters will also have subscription channel to the <a class="reference internal" href="#sns"><span class="std std-ref">SNS</span></a>. this way the <a class="reference internal" href="admin_management_services.html#admin-management-services"><span class="std std-ref">Admin Management Services</span></a> can push config changes or other updates to the clinic.</p>
</section>
<section id="ecr">
<h3>ECR<a class="headerlink" href="#ecr" title="Permalink to this headline"></a></h3>
<p>All Docker images will be managed in the Elastic container registry. Each service will have seperate repository and versioning.</p>
<p>The mechanisim to push images will be only from the CI phase.</p>
<p>We will have 10 version retention in the registry.
In addition, every deploy environment (stage, dev, prod) will have different tag:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">clinicult/&lt;service_name&gt;:&lt;env_name&gt;-X.Y.Z</span>
</pre></div>
</div>
<p>for example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">clinicult/user_service:stage-1.0.32</span>
</pre></div>
</div>
<p>In addition, Will be also <em>‘latest’</em> tag for the latest production environment.</p>
<p>ECR has option to enable image scanning. we need to enable this option and to add alter for security events.</p>
</section>
<section id="sns">
<h3>SNS<a class="headerlink" href="#sns" title="Permalink to this headline"></a></h3>
<p>SNS is a distributed publish-subscribe system. Messages are pushed to subscribers as and when they are sent by publishers to SNS.
Amazon SNS is a fast, flexible, fully managed push notification service that lets you send individual messages or to bulk messages to large numbers of recipients.</p>
<p>The <a class="reference internal" href="admin_management_services.html#admin-management-services"><span class="std std-ref">Admin Management Services</span></a> will have option to notify the clinics about configuration change or other notification with the SNS.
Each service in the clinic will option to subscribe on <a class="reference internal" href="admin_management_services.html#admin-management-services"><span class="std std-ref">Admin Management Services</span></a> notifications.
Each message will have different area of intrest (aka Topic). each service will subscribe to the relevant Topic.
For example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="nt">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;SubscriptionConfirmation&quot;</span><span class="p">,</span>
<span class="nt">&quot;MessageId&quot;</span> <span class="p">:</span> <span class="s2">&quot;165545c9-2a5c-472c-8df2-7ff2be2b3b1b&quot;</span><span class="p">,</span>
<span class="nt">&quot;Token&quot;</span> <span class="p">:</span> <span class="s2">&quot;2336412f37...&quot;</span><span class="p">,</span>
<span class="nt">&quot;TopicArn&quot;</span> <span class="p">:</span> <span class="s2">&quot;arn:aws:sns:us-west-2:123456789012:MyTopic&quot;</span><span class="p">,</span>
<span class="nt">&quot;Message&quot;</span> <span class="p">:</span> <span class="s2">&quot;You have chosen to subscribe to the topic arn:aws:sns:us-west-2:123456789012:MyTopic.\nTo confirm the subscription, visit the SubscribeURL included in this message.&quot;</span><span class="p">,</span>
<span class="nt">&quot;SubscribeURL&quot;</span> <span class="p">:</span> <span class="s2">&quot;https://sns.us-west-2.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-west-2:123456789012:MyTopic&amp;Token=2336412f37...&quot;</span><span class="p">,</span>
<span class="nt">&quot;Timestamp&quot;</span> <span class="p">:</span> <span class="s2">&quot;2012-04-26T20:45:04.751Z&quot;</span><span class="p">,</span>
<span class="nt">&quot;SignatureVersion&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="nt">&quot;Signature&quot;</span> <span class="p">:</span> <span class="s2">&quot;EXAMPLEpH+DcEwjAPg8O9mY8dReBSwksfg2S7WKQcikcNKWLQjwu6A4VbeS0QHVCkhRS7fUQvi2egU3N858fiTDN6bkkOxYDVrY0Ad8L10Hs3zH81mtnPk5uvvolIC1CXGu43obcgFxeL3khZl8IKvO61GWB6jI9b5+gLPoBc1Q=&quot;</span><span class="p">,</span>
<span class="nt">&quot;SigningCertURL&quot;</span> <span class="p">:</span> <span class="s2">&quot;https://sns.us-west-2.amazonaws.com/SimpleNotificationService-f3ecfb7224c7233fe7bb5f59f96de52f.pem&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To subscribe to this topic, the Service will create an SQS and will subscribe to the topic with sqs endpoint.
for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
        <span class="n">Protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">Endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">ReturnSubscriptionArn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subscribed </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> to topic </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">topic</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>
<span class="k">except</span> <span class="n">ClientError</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
        <span class="s2">&quot;Couldn&#39;t subscribe </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> to topic </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">topic</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>
    <span class="k">raise</span>
</pre></div>
</div>
<p>More examples can be found in <a class="reference external" href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/sns/sns_basics.py">Github</a></p>
</section>
<section id="amplify">
<h3>Amplify<a class="headerlink" href="#amplify" title="Permalink to this headline"></a></h3>
<p>For Clinicult Web Clients we will use <a class="reference external" href="https://aws.amazon.com/amplify/">AWS Amplify</a> infrastructure for serving and <a class="reference internal" href="#continous-integration"><span class="std std-ref">Continous Integration</span></a>.</p>
<p>AWS Amplify is a set of purpose-built tools and services that makes it quick and easy for front-end web and mobile developers build full-stack applications on AWS, with the flexibility to leverage the breadth of AWS services to further customize applications.</p>
</section>
<section id="schema">
<h3>Schema<a class="headerlink" href="#schema" title="Permalink to this headline"></a></h3>
<img alt="Services Outlet" src="_images/arch.png" />
</section>
</section>
<section id="source-control">
<h2>Source Control<a class="headerlink" href="#source-control" title="Permalink to this headline"></a></h2>
<p>All Code services will be managed by Source control. our code will be on <a class="reference external" href="https://github.com">Github</a>.
the entire code will be in single repository for easy managment and development cycle.</p>
</section>
<section id="continous-integration">
<h2>Continous Integration<a class="headerlink" href="#continous-integration" title="Permalink to this headline"></a></h2>
<p>The entire Continous Integration will be implemented in <a class="reference external" href="https://github.com/features/actions">Github-Actions</a>.</p>
<p>For each service the flow will be:</p>
<ol class="arabic simple">
<li><p>Run tests</p></li>
<li><p>Build <a class="reference internal" href="#docker"><span class="std std-ref">Docker</span></a> image</p></li>
<li><p>Upload image to <a class="reference internal" href="#ecr"><span class="std std-ref">ECR</span></a></p></li>
<li><p>Update <a class="reference internal" href="#ecs"><span class="std std-ref">ECS</span></a> service with the new image</p></li>
</ol>
<p>The flow can be change according to the code.</p>
<p>CI session will run only on the relevant code that changed. for example, if Service_a has changed, there is no need to run CI on service_b code.</p>
<p>The CI will run for each push to the relevant environemnts branches:</p>
<ol class="arabic simple">
<li><p><strong>main</strong> - production</p></li>
<li><p><strong>develop</strong> - staging</p></li>
<li><p><strong>development</strong> - testing</p></li>
</ol>
<p>the feature branches will exit from the development branch.</p>
<p>In addition, Clinicult should add integration to <a class="reference external" href="https://snyk.io/">Snyc</a> to enable vulnerabilities scanning.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="services.html" class="btn btn-neutral float-left" title="Services" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="admin_management_services.html" class="btn btn-neutral float-right" title="Admin Management Services" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Clinicult.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>